// Prisma schema for NFSe service

generator client {
  provider = "prisma-client-js"
  engineType = "library"
  binaryTargets = ["native", "rhel-openssl-1.0.x", "rhel-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum InvoiceStatus {
  PENDING
  SUCCESS
  REJECTED
  CANCELLED
}

enum LogLevel {
  TRACE
  DEBUG
  INFO
  WARN
  ERROR
}

model Invoice {
  id                String        @id @default(uuid())
  rpsNumber         String
  rpsSeries         String
  issueDate         DateTime
  providerCnpj      String
  customerDoc       String?
  serviceCode       String
  serviceDescription String?
  serviceAmount     Decimal       @db.Decimal(14,2)
  taxRate           Decimal       @db.Decimal(5,2)
  issRetained       Boolean       @default(false)
  cnae              String?
  deductionsAmount  Decimal?      @db.Decimal(14,2)
  status            InvoiceStatus @default(PENDING)
  nfseNumber        String?
  verificationCode  String?
  xmlBase64         String?
  pdfBase64         String?
  xmlHash           String?
  pdfHash           String?
  xmlSignedEncrypted String?      // JSON com objeto {iv,tag,data} ou null
  cancelReason      String?
  canceledAt        DateTime?
  rawNormalizedJson Json
  agentRequestHash  String?
  agentResponseHash String?
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt

  logs              LogEntry[]
  idempotencyKeys   IdempotencyKey[]

  @@unique([rpsNumber, rpsSeries, providerCnpj])
  @@index([status])
}

model LogEntry {
  id        String    @id @default(uuid())
  invoiceId String?
  invoice   Invoice?  @relation(fields: [invoiceId], references: [id])
  level     LogLevel
  message   String
  context   Json?
  traceId   String?
  createdAt DateTime  @default(now())

  @@index([invoiceId])
  @@index([createdAt])
}

model IdempotencyKey {
  key            String   @id
  invoiceId      String
  invoice        Invoice  @relation(fields: [invoiceId], references: [id])
  statusSnapshot InvoiceStatus
  responseJson   Json?
  payloadHash    String?
  createdAt      DateTime @default(now())
  lockedAt       DateTime?
  expiresAt      DateTime?

  @@index([expiresAt])
}

model WebhookConfig {
  id        String   @id @default(uuid())
  url       String
  secret    String?
  events    String[]
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Client {
  id          String   @id @default(uuid())
  name        String
  document    String   // CPF or CNPJ
  email       String?
  phone       String?
  address     Json?    // Address object
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([document])
  @@index([document])
}

model Supplier {
  id          String   @id @default(uuid())
  name        String
  document    String   // CNPJ
  email       String?
  phone       String?
  address     Json?    // Address object
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([document])
  @@index([document])
}

model ServiceType {
  id          String   @id @default(uuid())
  code        String   @unique // Código único do serviço (ex: "01.01", "02.05")
  name        String   // Nome do serviço
  issRetained Boolean  @default(false) // ISS retido na fonte
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([active])
}

enum AccountType {
  ASSET
  LIABILITY
  EQUITY
  REVENUE
  EXPENSE
}

model Account {
  id          String      @id @default(uuid())
  code        String      // Accounting code (e.g., "1.01.001")
  name        String
  type        AccountType
  parentId    String?     // For hierarchical accounts
  parent      Account?    @relation("AccountHierarchy", fields: [parentId], references: [id])
  children    Account[]   @relation("AccountHierarchy")
  description String?
  active      Boolean     @default(true)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  @@unique([code])
  @@index([type])
  @@index([parentId])
}
